# é«˜å¹¶å‘æ¶æ„ä¼˜åŒ–æ–¹æ¡ˆ - æ”¯æŒ10ä¸‡ç”¨æˆ·è®¿é—®

## ğŸ“Š å½“å‰æ–¹æ¡ˆæ‰¿è½½èƒ½åŠ›åˆ†æ

### å½“å‰é…ç½®
- **æœåŠ¡å™¨ï¼š** 2æ ¸4Gï¼Œ1Mbpså¸¦å®½
- **æ¶æ„ï¼š** å•å®ä¾‹åç«¯ + æœ¬åœ°PostgreSQL
- **å‰ç«¯ï¼š** OSS + CDNï¼ˆå·²ä¼˜åŒ–ï¼‰

### æ‰¿è½½èƒ½åŠ›è¯„ä¼°

#### ç†è®ºæœ€å¤§æ‰¿è½½èƒ½åŠ›
- **CPUï¼š** 2æ ¸ â‰ˆ 2000-4000 QPSï¼ˆç®€å•æŸ¥è¯¢ï¼‰
- **å†…å­˜ï¼š** 4G â‰ˆ æ”¯æŒ500-1000å¹¶å‘è¿æ¥
- **å¸¦å®½ï¼š** 1Mbps â‰ˆ 125KB/s â‰ˆ **ä¸¥é‡ç“¶é¢ˆ**
- **æ•°æ®åº“ï¼š** æœ¬åœ°PostgreSQL â‰ˆ 1000-2000 QPS

#### å®é™…æ‰¿è½½èƒ½åŠ›ï¼ˆä¿å®ˆä¼°è®¡ï¼‰
- **å¹¶å‘ç”¨æˆ·ï¼š** 500-1000äºº
- **QPSï¼š** 500-1000è¯·æ±‚/ç§’
- **æ—¥æ´»ç”¨æˆ·ï¼š** 5000-10000äºº

### âŒ ç»“è®ºï¼šå½“å‰æ–¹æ¡ˆ**æ— æ³•**æ”¯æŒ10ä¸‡ç”¨æˆ·

---

## ğŸ¯ 10ä¸‡ç”¨æˆ·è®¿é—®é‡éœ€æ±‚åˆ†æ

### è®¿é—®é‡ä¼°ç®—

å‡è®¾10ä¸‡æ³¨å†Œç”¨æˆ·ï¼š
- **æ—¥æ´»ç”¨æˆ·ï¼ˆDAUï¼‰ï¼š** 10,000-20,000äººï¼ˆ10-20%ï¼‰
- **åŒæ—¶åœ¨çº¿ï¼š** 1,000-2,000äººï¼ˆ1-2%ï¼‰
- **å³°å€¼å¹¶å‘ï¼š** 2,000-5,000äººï¼ˆæ´»åŠ¨æœŸé—´ï¼‰
- **å¹³å‡QPSï¼š** 500-1,000è¯·æ±‚/ç§’
- **å³°å€¼QPSï¼š** 2,000-5,000è¯·æ±‚/ç§’

### èµ„æºéœ€æ±‚

- **CPUï¼š** 8-16æ ¸
- **å†…å­˜ï¼š** 16-32G
- **å¸¦å®½ï¼š** 50-100Mbps
- **æ•°æ®åº“ï¼š** éœ€è¦è¯»å†™åˆ†ç¦»æˆ–é›†ç¾¤
- **å­˜å‚¨ï¼š** éœ€è¦ç‹¬ç«‹å­˜å‚¨ï¼ˆOSSï¼‰

---

## ğŸš€ ä¼˜åŒ–æ–¹æ¡ˆï¼šæ”¯æŒ10ä¸‡ç”¨æˆ·

### æ–¹æ¡ˆä¸€ï¼šå•æœåŠ¡å™¨ä¼˜åŒ–ï¼ˆé€‚åˆ5ä¸‡ç”¨æˆ·ä»¥å†…ï¼‰

#### æœåŠ¡å™¨é…ç½®å‡çº§
- **è§„æ ¼ï¼š** 8æ ¸16Gï¼Œ10Mbpså¸¦å®½
- **æˆæœ¬ï¼š** Â¥300-500/æœˆ

#### æ¶æ„ä¼˜åŒ–

```
ç”¨æˆ· â†’ CDN â†’ å‰ç«¯ï¼ˆOSSï¼‰
         â†“
      Nginxï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
         â†“
   åç«¯ï¼ˆPM2é›†ç¾¤ï¼Œ4-8è¿›ç¨‹ï¼‰
         â†“
   PostgreSQLï¼ˆè¿æ¥æ± ä¼˜åŒ–ï¼‰
         â†“
   Redisï¼ˆç¼“å­˜å±‚ï¼‰
```

#### ä¼˜åŒ–æªæ–½

1. **åç«¯ä¼˜åŒ–**
   - PM2é›†ç¾¤æ¨¡å¼ï¼ˆ4-8ä¸ªè¿›ç¨‹ï¼‰
   - æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–
   - æ·»åŠ Redisç¼“å­˜
   - APIå“åº”æ—¶é—´ä¼˜åŒ–

2. **æ•°æ®åº“ä¼˜åŒ–**
   - è¿æ¥æ± é…ç½®
   - æŸ¥è¯¢ä¼˜åŒ–
   - ç´¢å¼•ä¼˜åŒ–
   - è¯»å†™åˆ†ç¦»ï¼ˆå¯é€‰ï¼‰

3. **ç¼“å­˜ç­–ç•¥**
   - Redisç¼“å­˜çƒ­ç‚¹æ•°æ®
   - CDNç¼“å­˜é™æ€èµ„æº
   - æµè§ˆå™¨ç¼“å­˜

**æ‰¿è½½èƒ½åŠ›ï¼š** 5,000-10,000å¹¶å‘ï¼Œ5,000-10,000 QPS

---

### æ–¹æ¡ˆäºŒï¼šåˆ†å¸ƒå¼æ¶æ„ï¼ˆæ”¯æŒ10ä¸‡+ç”¨æˆ·ï¼‰

#### æ¶æ„è®¾è®¡

```
ç”¨æˆ· â†’ CDN â†’ å‰ç«¯ï¼ˆOSSï¼‰
         â†“
   Nginx/ALBï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
         â†“
   åç«¯é›†ç¾¤ï¼ˆ3-5å°ECSï¼‰
         â†“
   RDS PostgreSQLï¼ˆä¸»ä»ï¼‰
         â†“
   Redisé›†ç¾¤ï¼ˆç¼“å­˜ï¼‰
         â†“
   OSSï¼ˆæ–‡ä»¶å­˜å‚¨ï¼‰
```

#### æœåŠ¡å™¨é…ç½®

**åç«¯æœåŠ¡å™¨ï¼ˆ3-5å°ï¼‰ï¼š**
- è§„æ ¼ï¼š4æ ¸8Gï¼Œ10Mbps
- æˆæœ¬ï¼šÂ¥150-200/å°/æœˆ

**æ•°æ®åº“ï¼ˆRDSï¼‰ï¼š**
- è§„æ ¼ï¼š4æ ¸16Gï¼Œé«˜å¯ç”¨ç‰ˆ
- æˆæœ¬ï¼šÂ¥500-800/æœˆ

**Redisï¼ˆç¼“å­˜ï¼‰ï¼š**
- è§„æ ¼ï¼š2Gå†…å­˜
- æˆæœ¬ï¼šÂ¥100-200/æœˆ

**æ€»æˆæœ¬ï¼š** Â¥1,500-2,500/æœˆ

#### æ‰¿è½½èƒ½åŠ›
- **å¹¶å‘ç”¨æˆ·ï¼š** 10,000-20,000äºº
- **QPSï¼š** 10,000-20,000è¯·æ±‚/ç§’
- **æ—¥æ´»ç”¨æˆ·ï¼š** 50,000-100,000äºº

---

## ğŸ”§ å…·ä½“ä¼˜åŒ–æªæ–½

### 1. æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–

ä¿®æ”¹ `backend/src/utils/db.ts`ï¼š

```typescript
import { Pool } from 'pg';

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  max: 20,              // æœ€å¤§è¿æ¥æ•°ï¼ˆæ ¹æ®æœåŠ¡å™¨é…ç½®è°ƒæ•´ï¼‰
  min: 5,               // æœ€å°è¿æ¥æ•°
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,
});
```

### 2. PM2é›†ç¾¤æ¨¡å¼

åˆ›å»º `backend/ecosystem.config.js`ï¼š

```javascript
module.exports = {
  apps: [{
    name: 'forum-api',
    script: './dist/app.js',
    instances: 'max',  // ä½¿ç”¨æ‰€æœ‰CPUæ ¸å¿ƒ
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    max_memory_restart: '500M',
    error_file: '/var/log/forum/error.log',
    out_file: '/var/log/forum/out.log',
  }]
};
```

### 3. æ·»åŠ Redisç¼“å­˜

#### å®‰è£…Redis

```bash
sudo apt install redis-server
sudo systemctl start redis
sudo systemctl enable redis
```

#### åç«¯æ·»åŠ Redisæ”¯æŒ

```bash
cd backend
npm install redis ioredis
```

åˆ›å»º `backend/src/utils/redis.ts`ï¼š

```typescript
import Redis from 'ioredis';

const redis = new Redis({
  host: process.env.REDIS_HOST || 'localhost',
  port: parseInt(process.env.REDIS_PORT || '6379'),
  password: process.env.REDIS_PASSWORD,
  db: 0,
  maxRetriesPerRequest: 3,
});

export default redis;
```

#### ç¼“å­˜ç­–ç•¥ç¤ºä¾‹

```typescript
// ç¼“å­˜å¸–å­åˆ—è¡¨ï¼ˆ5åˆ†é’Ÿï¼‰
const cacheKey = `posts:${categoryId}:${page}`;
const cached = await redis.get(cacheKey);
if (cached) {
  return JSON.parse(cached);
}
// ... æŸ¥è¯¢æ•°æ®åº“
await redis.setex(cacheKey, 300, JSON.stringify(data));
```

### 4. Nginxè´Ÿè½½å‡è¡¡é…ç½®

```nginx
upstream backend {
    least_conn;  # æœ€å°‘è¿æ¥è´Ÿè½½å‡è¡¡
    server localhost:3000;
    server localhost:3001;
    server localhost:3002;
    server localhost:3003;
}

server {
    listen 80;
    server_name api.yourdomain.com;

    location / {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
```

### 5. æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

#### æ·»åŠ ç´¢å¼•

```sql
-- å¸–å­åˆ—è¡¨æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_posts_category_created ON posts(category_id, created_at DESC);
CREATE INDEX idx_posts_user_created ON posts(user_id, created_at DESC);

-- è¯„è®ºæŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_comments_post_created ON comments(post_id, created_at DESC);
CREATE INDEX idx_comments_user_created ON comments(user_id, created_at DESC);
```

#### åˆ†é¡µä¼˜åŒ–

```typescript
// ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µä»£æ›¿åç§»åˆ†é¡µï¼ˆå¤§æ•°æ®é‡æ—¶ï¼‰
const posts = await prisma.post.findMany({
  where: { categoryId, createdAt: { lt: cursor } },
  take: 20,
  orderBy: { createdAt: 'desc' },
});
```

### 6. APIé™æµ

å®‰è£…é™æµä¸­é—´ä»¶ï¼š

```bash
npm install express-rate-limit
```

```typescript
import rateLimit from 'express-rate-limit';

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15åˆ†é’Ÿ
  max: 100, // æ¯ä¸ªIPæœ€å¤š100ä¸ªè¯·æ±‚
});

app.use('/api/', limiter);
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–æ¸…å•

### åç«¯ä¼˜åŒ–
- [ ] PM2é›†ç¾¤æ¨¡å¼ï¼ˆå¤šè¿›ç¨‹ï¼‰
- [ ] æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–
- [ ] Redisç¼“å­˜çƒ­ç‚¹æ•°æ®
- [ ] APIå“åº”æ—¶é—´ä¼˜åŒ–ï¼ˆ<200msï¼‰
- [ ] æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
- [ ] æ·»åŠ APIé™æµ
- [ ] å¯ç”¨Gzipå‹ç¼©
- [ ] é™æ€èµ„æºCDNåŠ é€Ÿ

### æ•°æ®åº“ä¼˜åŒ–
- [ ] æ·»åŠ å¿…è¦ç´¢å¼•
- [ ] æŸ¥è¯¢ä¼˜åŒ–ï¼ˆé¿å…N+1ï¼‰
- [ ] è¿æ¥æ± é…ç½®
- [ ] å®šæœŸVACUUMå’ŒANALYZE
- [ ] è€ƒè™‘è¯»å†™åˆ†ç¦»ï¼ˆé«˜å¹¶å‘æ—¶ï¼‰

### å‰ç«¯ä¼˜åŒ–
- [ ] ä»£ç åˆ†å‰²å’Œæ‡’åŠ è½½
- [ ] å›¾ç‰‡æ‡’åŠ è½½å’Œå‹ç¼©
- [ ] é™æ€èµ„æºCDN
- [ ] æµè§ˆå™¨ç¼“å­˜ç­–ç•¥
- [ ] å‡å°‘HTTPè¯·æ±‚

### åŸºç¡€è®¾æ–½
- [ ] è´Ÿè½½å‡è¡¡ï¼ˆNginx/ALBï¼‰
- [ ] ç›‘æ§å’Œå‘Šè­¦
- [ ] æ—¥å¿—èšåˆ
- [ ] è‡ªåŠ¨æ‰©å®¹ï¼ˆå¯é€‰ï¼‰

---

## ğŸ’° æˆæœ¬å¯¹æ¯”

### å½“å‰æ–¹æ¡ˆï¼ˆ2æ ¸4Gï¼‰
- **æˆæœ¬ï¼š** Â¥83/æœˆ
- **æ‰¿è½½ï¼š** 500-1000å¹¶å‘
- **é€‚åˆï¼š** MVPé˜¶æ®µï¼Œ<5000ç”¨æˆ·

### ä¼˜åŒ–æ–¹æ¡ˆä¸€ï¼ˆ8æ ¸16Gå•æœºï¼‰
- **æˆæœ¬ï¼š** Â¥300-500/æœˆ
- **æ‰¿è½½ï¼š** 5000-10000å¹¶å‘
- **é€‚åˆï¼š** 5ä¸‡ç”¨æˆ·ä»¥å†…

### ä¼˜åŒ–æ–¹æ¡ˆäºŒï¼ˆåˆ†å¸ƒå¼ï¼‰
- **æˆæœ¬ï¼š** Â¥1,500-2,500/æœˆ
- **æ‰¿è½½ï¼š** 10000-20000å¹¶å‘
- **é€‚åˆï¼š** 10ä¸‡+ç”¨æˆ·

---

## ğŸ¯ æ¨èæ–¹æ¡ˆ

### é˜¶æ®µä¸€ï¼šMVPä¸Šçº¿ï¼ˆ<5000ç”¨æˆ·ï¼‰
- **å½“å‰æ–¹æ¡ˆï¼š** 2æ ¸4Gå•æœº
- **æˆæœ¬ï¼š** Â¥83/æœˆ
- **ä¼˜åŒ–ï¼š** åŸºç¡€ä¼˜åŒ–å³å¯

### é˜¶æ®µäºŒï¼šæˆé•¿æœŸï¼ˆ5000-50000ç”¨æˆ·ï¼‰
- **æ–¹æ¡ˆï¼š** 8æ ¸16Gå•æœº + Redis
- **æˆæœ¬ï¼š** Â¥400-600/æœˆ
- **ä¼˜åŒ–ï¼š** PM2é›†ç¾¤ + ç¼“å­˜ + æ•°æ®åº“ä¼˜åŒ–

### é˜¶æ®µä¸‰ï¼šæˆç†ŸæœŸï¼ˆ50000+ç”¨æˆ·ï¼‰
- **æ–¹æ¡ˆï¼š** åˆ†å¸ƒå¼æ¶æ„
- **æˆæœ¬ï¼š** Â¥1,500-2,500/æœˆ
- **ä¼˜åŒ–ï¼š** è´Ÿè½½å‡è¡¡ + æ•°æ®åº“é›†ç¾¤ + Redisé›†ç¾¤

---

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

éœ€è¦ç›‘æ§çš„å…³é”®æŒ‡æ ‡ï¼š

1. **æœåŠ¡å™¨èµ„æº**
   - CPUä½¿ç”¨ç‡ < 70%
   - å†…å­˜ä½¿ç”¨ç‡ < 80%
   - å¸¦å®½ä½¿ç”¨ç‡ < 80%

2. **åº”ç”¨æ€§èƒ½**
   - APIå“åº”æ—¶é—´ < 200msï¼ˆP95ï¼‰
   - é”™è¯¯ç‡ < 0.1%
   - QPSå³°å€¼

3. **æ•°æ®åº“**
   - è¿æ¥æ•° < 80%
   - æŸ¥è¯¢æ—¶é—´ < 100ms
   - æ…¢æŸ¥è¯¢æ•°é‡

4. **ç¼“å­˜**
   - Rediså‘½ä¸­ç‡ > 80%
   - å†…å­˜ä½¿ç”¨ç‡ < 80%

---

## ğŸš¨ æ‰©å®¹è§¦å‘æ¡ä»¶

å½“ä»¥ä¸‹æŒ‡æ ‡æŒç»­è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œè€ƒè™‘æ‰©å®¹ï¼š

- CPUä½¿ç”¨ç‡ > 70% æŒç»­1å°æ—¶
- å†…å­˜ä½¿ç”¨ç‡ > 80% æŒç»­1å°æ—¶
- APIå“åº”æ—¶é—´ > 500msï¼ˆP95ï¼‰
- é”™è¯¯ç‡ > 1%
- æ•°æ®åº“è¿æ¥æ•° > 80%

---

## ğŸ“ æ€»ç»“

### å½“å‰æ–¹æ¡ˆ
- âŒ **æ— æ³•**æ”¯æŒ10ä¸‡ç”¨æˆ·
- âœ… é€‚åˆMVPé˜¶æ®µï¼ˆ<5000ç”¨æˆ·ï¼‰
- âœ… æˆæœ¬ä½ï¼ˆÂ¥83/æœˆï¼‰

### æ”¯æŒ10ä¸‡ç”¨æˆ·çš„æ–¹æ¡ˆ
- âœ… éœ€è¦åˆ†å¸ƒå¼æ¶æ„
- âœ… éœ€è¦ç¼“å­˜å±‚ï¼ˆRedisï¼‰
- âœ… éœ€è¦è´Ÿè½½å‡è¡¡
- âœ… éœ€è¦æ•°æ®åº“ä¼˜åŒ–
- ğŸ’° æˆæœ¬ï¼šÂ¥1,500-2,500/æœˆ

### å»ºè®®
1. **å…ˆä½¿ç”¨å½“å‰æ–¹æ¡ˆä¸Šçº¿MVP**
2. **ç›‘æ§å®é™…è®¿é—®é‡**
3. **æ ¹æ®å®é™…éœ€æ±‚é€æ­¥ä¼˜åŒ–**
4. **é¿å…è¿‡æ—©ä¼˜åŒ–**

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0  
**åˆ›å»ºæ—¥æœŸï¼š** 2026-02-05
