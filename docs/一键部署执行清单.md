# 一键部署执行清单

按顺序执行，每步完成后再进行下一步。

---

## 第一步：本地准备（在 Windows 上执行）

### 1.1 查看并保存凭证

打开 `docs/部署凭证-请妥善保管.md`，保存其中的：
- JWT_SECRET
- DB_PASSWORD（用于 DATABASE_URL 时，将 `+` 改为 `%2B`，`/` 改为 `%2F`）

### 1.2 提交代码到 Git

```powershell
cd d:\idea\forum
git add .
git commit -m "chore: 准备生产部署"
git push origin main
```

> 如果没有远程仓库，先在 GitHub/Gitee 创建仓库并关联。

---

## 第二步：购买并连接服务器

1. 购买轻量应用服务器（2核4G，Ubuntu 22.04）
2. 获取服务器公网 IP
3. 使用 SSH 连接：
   ```bash
   ssh root@你的服务器IP
   ```

---

## 第三步：服务器环境安装（复制整段执行）

```bash
sudo apt update && sudo apt upgrade -y
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs
sudo apt install -y postgresql postgresql-contrib nginx
sudo systemctl start postgresql nginx
sudo systemctl enable postgresql nginx
sudo npm install -g pm2
pm2 startup
sudo mkdir -p /var/www/forum /var/log/forum
sudo chown -R $USER:$USER /var/www/forum /var/log/forum
```

---

## 第四步：配置数据库

```bash
sudo -u postgres psql
```

在 psql 中执行（把 `你的数据库密码` 换成 部署凭证 中的 DB_PASSWORD，如有 `+` 或 `/` 需在命令行里原样输入）：

```sql
CREATE DATABASE forum;
CREATE USER forum_user WITH PASSWORD '你的数据库密码';
GRANT ALL PRIVILEGES ON DATABASE forum TO forum_user;
ALTER USER forum_user CREATEDB;
\q
```

---

## 第五步：克隆代码

```bash
cd /var/www/forum
git clone https://github.com/你的用户名/forum.git .
```

---

## 第六步：配置并启动后端

```bash
cd /var/www/forum/backend
npm install --production
cp .env.example .env
nano .env
```

编辑 .env，填写（**密码中的 + 要写成 %2B，/ 要写成 %2F**）：

```env
NODE_ENV=production
PORT=3000
DATABASE_URL=postgresql://forum_user:UtYVxrc6MODvlElugKrb6ag%2BTUx8b8yx@localhost:5432/forum?schema=public
JWT_SECRET=4932c359a03833e3b5f86588b4ee3155410898a01192b30fcf67a8658571b6d7
JWT_EXPIRES_IN=7d
CORS_ORIGIN=http://你的服务器IP,http://localhost:3000
DB_POOL_MAX=20
DB_POOL_MIN=5
LOG_LEVEL=info
```

保存后执行：

```bash
npx prisma generate
npx prisma migrate deploy
npx tsx prisma/seed-admin.ts
npm run build
pm2 start dist/app.js --name forum-api
pm2 save
curl http://localhost:3000/api/health
```

应返回 `{"success":true,...}`

---

## 第七步：配置并构建前端

```bash
cd /var/www/forum/frontend
npm install
# 同服务器部署时使用相对路径 /api（留空即可）
echo "VITE_API_URL=" > .env.production
npm run build
```

---

## 第八步：配置 Nginx（单 IP 部署）

```bash
sudo nano /etc/nginx/sites-available/forum
```

粘贴以下内容（**把 你的服务器IP 替换成实际 IP**）：

```nginx
server {
    listen 80;
    server_name 你的服务器IP;

    client_max_body_size 50M;

    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /uploads {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
    }

    location / {
        root /var/www/forum/frontend/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
}
```

启用并重载：

```bash
sudo ln -sf /etc/nginx/sites-available/forum /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

---

## 第九步：配置防火墙 / 安全组

- 云控制台安全组：放行 80、443
- 如启用 ufw：`sudo ufw allow 80 && sudo ufw allow 443 && sudo ufw enable`

---

## 第十步：验证

浏览器访问：`http://你的服务器IP`

- [ ] 页面正常打开
- [ ] 能注册、登录
- [ ] 能发帖
- [ ] 管理后台 `/admin` 能访问

---

## 管理员账号

- 超级管理员：admin@forum.edu / admin123456
- 普通管理员：moderator@forum.edu / moderator123456

**上线后请立即修改密码！**
