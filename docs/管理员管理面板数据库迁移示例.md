# ç®¡ç†å‘˜ç®¡ç†é¢æ¿ - æ•°æ®åº“è¿ç§»ç¤ºä¾‹

## ğŸ“‹ è¿ç§»æ­¥éª¤

### 1. ä¿®æ”¹ Prisma Schema

åœ¨ `backend/prisma/schema.prisma` ä¸­ï¼š

```prisma
model User {
  id          String   @id @default(uuid())
  email       String   @unique
  username    String   @unique
  passwordHash String  @map("password_hash")
  phone       String?  @unique
  avatarUrl   String?  @map("avatar_url")
  bio         String?  @db.Text
  isVerified  Boolean  @default(false) @map("is_verified")
  isActive    Boolean  @default(true) @map("is_active")
  role        String   @default("user") // æ–°å¢ï¼š'user' | 'admin' | 'super_admin'
  isAdmin     Boolean  @default(false) @map("is_admin") // æ–°å¢ï¼šå…¼å®¹å­—æ®µ
  lastLoginAt DateTime? @map("last_login_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // å…³ç³»
  posts           Post[]
  comments        Comment[]
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
  likes            Like[]
  favorites        Favorite[]
  followers        Follow[] @relation("Follower")
  following        Follow[] @relation("Following")
  notifications    Notification[]
  resources        Resource[]
  adminLogs        AdminLog[] @relation("AdminLogs") // æ–°å¢å…³ç³»

  @@index([email])
  @@index([username])
  @@index([phone])
  @@index([role]) // æ–°å¢ç´¢å¼•
  @@map("users")
}

// æ–°å¢ï¼šç®¡ç†å‘˜æ“ä½œæ—¥å¿—è¡¨
model AdminLog {
  id          String   @id @default(uuid())
  adminId     String   @map("admin_id")
  action      String   // 'delete_post' | 'ban_user' | 'create_category' ç­‰
  targetType  String?  @map("target_type") // 'post' | 'user' | 'comment' | 'category' ç­‰
  targetId    String?  @map("target_id")
  description String?  @db.Text
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent") @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  admin User @relation("AdminLogs", fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([action])
  @@index([targetType, targetId])
  @@index([createdAt(sort: Desc)])
  @@map("admin_logs")
}
```

### 2. åˆ›å»ºè¿ç§»

```bash
cd backend
npx prisma migrate dev --name add_admin_system
```

### 3. åˆ›å»ºç§å­æ•°æ®è„šæœ¬

åˆ›å»º `backend/prisma/seed-admin.ts`ï¼š

```typescript
import { PrismaClient } from '@prisma/client';
import { hashPassword } from '../src/utils/password.js';

const prisma = new PrismaClient();

async function main() {
  console.log('å¼€å§‹åˆ›å»ºç®¡ç†å‘˜è´¦å·...');

  // åˆ›å»ºè¶…çº§ç®¡ç†å‘˜
  const superAdmin = await prisma.user.upsert({
    where: { email: 'admin@forum.edu' },
    update: {},
    create: {
      email: 'admin@forum.edu',
      username: 'admin',
      passwordHash: await hashPassword('admin123456'), // è¯·ä¿®æ”¹é»˜è®¤å¯†ç 
      role: 'super_admin',
      isAdmin: true,
      isVerified: true,
      isActive: true,
    },
  });

  console.log('è¶…çº§ç®¡ç†å‘˜åˆ›å»ºæˆåŠŸ:', superAdmin);

  // åˆ›å»ºæ™®é€šç®¡ç†å‘˜ï¼ˆå¯é€‰ï¼‰
  const admin = await prisma.user.upsert({
    where: { email: 'moderator@forum.edu' },
    update: {},
    create: {
      email: 'moderator@forum.edu',
      username: 'moderator',
      passwordHash: await hashPassword('moderator123456'), // è¯·ä¿®æ”¹é»˜è®¤å¯†ç 
      role: 'admin',
      isAdmin: true,
      isVerified: true,
      isActive: true,
    },
  });

  console.log('ç®¡ç†å‘˜åˆ›å»ºæˆåŠŸ:', admin);
}

main()
  .catch((e) => {
    console.error(e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
```

### 4. è¿è¡Œç§å­è„šæœ¬

```bash
cd backend
npx tsx prisma/seed-admin.ts
```

---

## ğŸ” éªŒè¯è¿ç§»

### æ£€æŸ¥Userè¡¨

```sql
-- æŸ¥çœ‹ç”¨æˆ·è§’è‰²åˆ†å¸ƒ
SELECT role, COUNT(*) as count 
FROM users 
GROUP BY role;

-- æŸ¥çœ‹ç®¡ç†å‘˜åˆ—è¡¨
SELECT id, email, username, role, is_admin, is_active 
FROM users 
WHERE role IN ('admin', 'super_admin');
```

### æ£€æŸ¥AdminLogè¡¨

```sql
-- æŸ¥çœ‹è¡¨ç»“æ„
\d admin_logs

-- æŸ¥çœ‹ç´¢å¼•
SELECT indexname, indexdef 
FROM pg_indexes 
WHERE tablename = 'admin_logs';
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¤‡ä»½æ•°æ®**ï¼šè¿ç§»å‰è¯·å¤‡ä»½æ•°æ®åº“
2. **é»˜è®¤å¯†ç **ï¼šåˆ›å»ºç®¡ç†å‘˜åè¯·ç«‹å³ä¿®æ”¹é»˜è®¤å¯†ç 
3. **æƒé™æ§åˆ¶**ï¼šç¡®ä¿åªæœ‰ç®¡ç†å‘˜å¯ä»¥è®¿é—®ç®¡ç†é¢æ¿
4. **æ•°æ®è¿ç§»**ï¼šå¦‚æœå·²æœ‰æ•°æ®ï¼Œéœ€è¦æ‰‹åŠ¨è®¾ç½®ç°æœ‰ç”¨æˆ·çš„ role

---

## ğŸ”„ å›æ»šè¿ç§»ï¼ˆå¦‚éœ€è¦ï¼‰

```bash
# æŸ¥çœ‹è¿ç§»å†å²
npx prisma migrate status

# å›æ»šåˆ°ä¸Šä¸€ä¸ªè¿ç§»
npx prisma migrate resolve --rolled-back <migration_name>
```
