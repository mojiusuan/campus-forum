# 服务器构建失败排查指南

## 为什么本地构建成功、服务器构建失败？

常见原因：

| 原因 | 说明 | 解决方式 |
|------|------|----------|
| **代码未同步** | 服务器未拉取最新代码 | `git pull origin main` |
| **npm install --production** | 跳过了 devDependencies，缺少 TypeScript、@types/* | 构建前用 `npm install`（不加 --production） |
| **未执行 prisma generate** | PrismaClient 未生成 | `npm run build` 会自动执行 prebuild |
| **NODE_ENV=production** | 导致 npm install 跳过 devDependencies | 构建时临时 `unset NODE_ENV` 或 `NODE_ENV=development npm install` |
| **node_modules 脏** | 之前装错或版本冲突 | `rm -rf node_modules package-lock.json && npm install` |

## 正确的服务器构建流程

```bash
cd /var/www/forum
git pull origin main
cd backend

# 关键：完整安装依赖（不要 --production）
rm -rf node_modules package-lock.json
npm install

# 构建（会自动执行 prisma generate）
npm run build
```

## 一键修复命令

若构建仍失败，在 backend 目录执行：

```bash
cd /var/www/forum/backend
rm -rf node_modules package-lock.json dist
unset NODE_ENV
npm install
npx prisma generate
npm run build
```

## 验证环境

构建前可检查：

```bash
# 1. 是否有 TypeScript
ls node_modules/typescript/package.json

# 2. 是否有 @types/pg（已在 dependencies，应存在）
ls node_modules/@types/pg

# 3. Prisma Client 是否已生成
ls node_modules/.prisma/client/index.js
```
