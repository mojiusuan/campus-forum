# 校园论坛项目 - 数据库设计文档

## 📋 文档信息

- **设计日期：** 2026-02-06
- **数据库类型：** PostgreSQL 15+
- **ORM工具：** Prisma
- **设计原则：** 成熟、现代、科学、高效

---

## 一、设计原则

### 1.1 核心原则

1. **规范化设计**
   - 遵循数据库第三范式（3NF）
   - 避免数据冗余
   - 保证数据一致性

2. **性能优化**
   - 合理使用索引
   - 优化查询性能
   - 支持分页和排序

3. **可扩展性**
   - 预留扩展字段
   - 支持软删除
   - 支持版本管理

4. **安全性**
   - 使用UUID作为主键
   - 密码加密存储
   - 敏感信息保护

5. **现代化**
   - 使用Prisma ORM
   - 支持TypeScript类型
   - 自动生成迁移文件

---

## 二、数据库表结构

### 2.1 用户表（users）

**表名：** `users`  
**用途：** 存储用户基本信息

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK | 用户ID（主键） |
| email | VARCHAR | UNIQUE, NOT NULL | 邮箱（唯一） |
| username | VARCHAR | UNIQUE, NOT NULL | 用户名（唯一） |
| password_hash | VARCHAR | NOT NULL | 密码哈希值 |
| phone | VARCHAR | UNIQUE, NULL | 手机号（唯一，可选） |
| avatar_url | VARCHAR | NULL | 头像URL |
| bio | TEXT | NULL | 个人简介 |
| is_verified | BOOLEAN | DEFAULT false | 是否已验证 |
| is_active | BOOLEAN | DEFAULT true | 是否激活 |
| last_login_at | TIMESTAMP | NULL | 最后登录时间 |
| created_at | TIMESTAMP | DEFAULT now() | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT now() | 更新时间 |

**索引：**
- `idx_users_email` - email字段
- `idx_users_username` - username字段
- `idx_users_phone` - phone字段

**关系：**
- 一对多：posts（帖子）
- 一对多：comments（评论）
- 一对多：messages（私信）
- 一对多：likes（点赞）
- 一对多：favorites（收藏）
- 多对多：follows（关注）

---

### 2.2 分类表（categories）

**表名：** `categories`  
**用途：** 存储帖子分类信息

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK | 分类ID（主键） |
| name | VARCHAR | NOT NULL | 分类名称 |
| slug | VARCHAR | UNIQUE, NOT NULL | 分类标识（URL友好） |
| description | TEXT | NULL | 分类描述 |
| icon | VARCHAR | NULL | 图标名称 |
| color | VARCHAR | DEFAULT '#3b82f6' | 主题颜色 |
| sort_order | INTEGER | DEFAULT 0 | 排序顺序 |
| is_active | BOOLEAN | DEFAULT true | 是否激活 |
| post_count | INTEGER | DEFAULT 0 | 帖子数量（冗余字段，提高性能） |
| created_at | TIMESTAMP | DEFAULT now() | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT now() | 更新时间 |

**索引：**
- `idx_categories_slug` - slug字段
- `idx_categories_sort_order` - sort_order字段

**关系：**
- 一对多：posts（帖子）

**预设分类：**
- 学习（study）
- 生活（life）
- 娱乐（entertainment）
- 交易（trade）
- 活动（activity）
- 其他（other）

---

### 2.3 帖子表（posts）

**表名：** `posts`  
**用途：** 存储帖子内容

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK | 帖子ID（主键） |
| user_id | UUID | FK, NOT NULL | 用户ID（外键） |
| category_id | UUID | FK, NOT NULL | 分类ID（外键） |
| title | VARCHAR | NOT NULL | 帖子标题 |
| content | TEXT | NOT NULL | 帖子内容 |
| images | TEXT[] | DEFAULT [] | 图片URL数组 |
| view_count | INTEGER | DEFAULT 0 | 浏览次数 |
| like_count | INTEGER | DEFAULT 0 | 点赞数（冗余字段） |
| comment_count | INTEGER | DEFAULT 0 | 评论数（冗余字段） |
| favorite_count | INTEGER | DEFAULT 0 | 收藏数（冗余字段） |
| is_pinned | BOOLEAN | DEFAULT false | 是否置顶 |
| is_locked | BOOLEAN | DEFAULT false | 是否锁定 |
| is_deleted | BOOLEAN | DEFAULT false | 是否删除（软删除） |
| created_at | TIMESTAMP | DEFAULT now() | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT now() | 更新时间 |
| deleted_at | TIMESTAMP | NULL | 删除时间 |

**索引：**
- `idx_posts_user_id` - user_id字段
- `idx_posts_category_id` - category_id字段
- `idx_posts_created_at_desc` - created_at字段（降序）
- `idx_posts_like_count_desc` - like_count字段（降序）
- `idx_posts_view_count_desc` - view_count字段（降序）
- `idx_posts_is_deleted_created_at` - 复合索引（is_deleted + created_at）

**关系：**
- 多对一：user（用户）
- 多对一：category（分类）
- 一对多：comments（评论）
- 一对多：likes（点赞）
- 一对多：favorites（收藏）

**设计说明：**
- 使用冗余字段（like_count、comment_count）提高查询性能
- 支持软删除，保留数据用于审计
- 支持置顶和锁定功能

---

### 2.4 评论表（comments）

**表名：** `comments`  
**用途：** 存储评论和回复（支持嵌套）

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK | 评论ID（主键） |
| post_id | UUID | FK, NOT NULL | 帖子ID（外键） |
| user_id | UUID | FK, NOT NULL | 用户ID（外键） |
| parent_id | UUID | FK, NULL | 父评论ID（外键，支持嵌套回复） |
| content | TEXT | NOT NULL | 评论内容 |
| like_count | INTEGER | DEFAULT 0 | 点赞数（冗余字段） |
| reply_count | INTEGER | DEFAULT 0 | 回复数（冗余字段） |
| is_deleted | BOOLEAN | DEFAULT false | 是否删除（软删除） |
| created_at | TIMESTAMP | DEFAULT now() | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT now() | 更新时间 |
| deleted_at | TIMESTAMP | NULL | 删除时间 |

**索引：**
- `idx_comments_post_id` - post_id字段
- `idx_comments_user_id` - user_id字段
- `idx_comments_parent_id` - parent_id字段
- `idx_comments_created_at_desc` - created_at字段（降序）
- `idx_comments_is_deleted_created_at` - 复合索引

**关系：**
- 多对一：post（帖子）
- 多对一：user（用户）
- 自关联：parent（父评论）
- 一对多：replies（子回复）
- 一对多：likes（点赞）

**设计说明：**
- 支持嵌套回复（通过parent_id实现）
- 使用冗余字段提高性能
- 支持软删除

---

### 2.5 点赞表（likes）

**表名：** `likes`  
**用途：** 存储点赞记录（支持帖子和评论）

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK | 点赞ID（主键） |
| user_id | UUID | FK, NOT NULL | 用户ID（外键） |
| target_type | VARCHAR | NOT NULL | 目标类型（'post' | 'comment'） |
| target_id | UUID | NOT NULL | 目标ID |
| created_at | TIMESTAMP | DEFAULT now() | 创建时间 |

**唯一约束：**
- `unique_user_target` - (user_id, target_type, target_id)

**索引：**
- `idx_likes_target` - (target_type, target_id)
- `idx_likes_user_id` - user_id字段
- `idx_likes_created_at` - created_at字段

**关系：**
- 多对一：user（用户）

**设计说明：**
- 使用多态设计，支持对帖子和评论点赞
- 使用唯一约束防止重复点赞
- 通过target_type和target_id关联不同表

---

### 2.6 收藏表（favorites）

**表名：** `favorites`  
**用途：** 存储收藏记录

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK | 收藏ID（主键） |
| user_id | UUID | FK, NOT NULL | 用户ID（外键） |
| post_id | UUID | FK, NOT NULL | 帖子ID（外键） |
| created_at | TIMESTAMP | DEFAULT now() | 创建时间 |

**唯一约束：**
- `unique_user_post` - (user_id, post_id)

**索引：**
- `idx_favorites_user_id` - user_id字段
- `idx_favorites_post_id` - post_id字段
- `idx_favorites_created_at_desc` - created_at字段（降序）

**关系：**
- 多对一：user（用户）
- 多对一：post（帖子）

**设计说明：**
- 使用唯一约束防止重复收藏
- 支持按时间排序查询

---

### 2.7 私信表（messages）

**表名：** `messages`  
**用途：** 存储用户之间的私信

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK | 消息ID（主键） |
| sender_id | UUID | FK, NOT NULL | 发送者ID（外键） |
| receiver_id | UUID | FK, NOT NULL | 接收者ID（外键） |
| content | TEXT | NOT NULL | 消息内容 |
| image_url | VARCHAR | NULL | 图片URL |
| is_read | BOOLEAN | DEFAULT false | 是否已读 |
| read_at | TIMESTAMP | NULL | 已读时间 |
| created_at | TIMESTAMP | DEFAULT now() | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT now() | 更新时间 |

**索引：**
- `idx_messages_sender_receiver` - (sender_id, receiver_id)
- `idx_messages_receiver_is_read` - (receiver_id, is_read)
- `idx_messages_receiver_created_at_desc` - (receiver_id, created_at DESC)
- `idx_messages_created_at` - created_at字段

**关系：**
- 多对一：sender（发送者）
- 多对一：receiver（接收者）

**设计说明：**
- 支持文字和图片消息
- 支持已读/未读状态
- 优化接收者查询性能

---

### 2.8 通知表（notifications）

**表名：** `notifications`  
**用途：** 存储系统通知

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK | 通知ID（主键） |
| user_id | UUID | FK, NOT NULL | 用户ID（外键） |
| type | VARCHAR | NOT NULL | 通知类型 |
| title | VARCHAR | NOT NULL | 通知标题 |
| content | TEXT | NOT NULL | 通知内容 |
| link | VARCHAR | NULL | 跳转链接 |
| related_id | UUID | NULL | 关联ID（帖子ID、评论ID等） |
| is_read | BOOLEAN | DEFAULT false | 是否已读 |
| read_at | TIMESTAMP | NULL | 已读时间 |
| created_at | TIMESTAMP | DEFAULT now() | 创建时间 |

**通知类型（type）：**
- `like` - 点赞通知
- `comment` - 评论通知
- `reply` - 回复通知
- `follow` - 关注通知
- `message` - 私信通知
- `system` - 系统通知

**索引：**
- `idx_notifications_user_is_read` - (user_id, is_read)
- `idx_notifications_user_created_at_desc` - (user_id, created_at DESC)
- `idx_notifications_type` - type字段

**关系：**
- 多对一：user（用户）

**设计说明：**
- 支持多种通知类型
- 支持关联跳转
- 优化未读通知查询

---

### 2.9 学习资料表（resources）

**表名：** `resources`  
**用途：** 存储学习资料文件

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK | 资料ID（主键） |
| user_id | UUID | FK, NOT NULL | 用户ID（外键） |
| title | VARCHAR | NOT NULL | 资料标题 |
| description | TEXT | NULL | 资料描述 |
| file_url | VARCHAR | NOT NULL | 文件URL |
| file_name | VARCHAR | NOT NULL | 文件名 |
| file_size | INTEGER | NOT NULL | 文件大小（字节） |
| file_type | VARCHAR | NOT NULL | 文件类型 |
| download_count | INTEGER | DEFAULT 0 | 下载次数 |
| is_public | BOOLEAN | DEFAULT true | 是否公开 |
| is_deleted | BOOLEAN | DEFAULT false | 是否删除（软删除） |
| created_at | TIMESTAMP | DEFAULT now() | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT now() | 更新时间 |
| deleted_at | TIMESTAMP | NULL | 删除时间 |

**文件类型（file_type）：**
- `pdf` - PDF文档
- `doc` / `docx` - Word文档
- `ppt` / `pptx` - PowerPoint文档
- `xls` / `xlsx` - Excel文档
- `zip` / `rar` - 压缩文件
- `other` - 其他

**索引：**
- `idx_resources_user_id` - user_id字段
- `idx_resources_is_public_is_deleted` - (is_public, is_deleted)
- `idx_resources_created_at_desc` - created_at字段（降序）
- `idx_resources_download_count_desc` - download_count字段（降序）

**关系：**
- 多对一：user（用户）

**设计说明：**
- 支持多种文件类型
- 支持公开/私有设置
- 支持下载统计
- 支持软删除

---

### 2.10 关注表（follows）

**表名：** `follows`  
**用途：** 存储用户关注关系

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK | 关注ID（主键） |
| follower_id | UUID | FK, NOT NULL | 关注者ID（外键） |
| following_id | UUID | FK, NOT NULL | 被关注者ID（外键） |
| created_at | TIMESTAMP | DEFAULT now() | 创建时间 |

**唯一约束：**
- `unique_follower_following` - (follower_id, following_id)

**索引：**
- `idx_follows_follower_id` - follower_id字段
- `idx_follows_following_id` - following_id字段
- `idx_follows_created_at` - created_at字段

**关系：**
- 多对一：follower（关注者）
- 多对一：following（被关注者）

**设计说明：**
- 使用唯一约束防止重复关注
- 支持查询关注列表和粉丝列表
- 不能自己关注自己（需要在应用层验证）

---

## 三、数据库关系图

```
users (用户)
  ├── posts (帖子) 1:N
  ├── comments (评论) 1:N
  ├── messages (私信) 1:N (发送/接收)
  ├── likes (点赞) 1:N
  ├── favorites (收藏) 1:N
  ├── follows (关注) N:M (关注者/被关注者)
  ├── notifications (通知) 1:N
  └── resources (学习资料) 1:N

categories (分类)
  └── posts (帖子) 1:N

posts (帖子)
  ├── comments (评论) 1:N
  ├── likes (点赞) 1:N
  └── favorites (收藏) 1:N

comments (评论)
  ├── replies (回复) 1:N (自关联)
  └── likes (点赞) 1:N
```

---

## 四、索引设计

### 4.1 索引策略

1. **主键索引**
   - 所有表使用UUID作为主键，自动创建主键索引

2. **唯一索引**
   - email、username、phone（用户表）
   - slug（分类表）
   - (user_id, target_type, target_id)（点赞表）
   - (user_id, post_id)（收藏表）
   - (follower_id, following_id)（关注表）

3. **外键索引**
   - 所有外键字段自动创建索引

4. **查询优化索引**
   - 时间字段降序索引（created_at DESC）
   - 计数字段降序索引（like_count DESC）
   - 复合索引（is_deleted + created_at）

### 4.2 索引使用场景

**用户查询：**
- 按email/username查询用户
- 按phone查询用户

**帖子查询：**
- 按分类查询帖子列表
- 按时间排序（最新）
- 按热度排序（点赞数）
- 按浏览量排序

**评论查询：**
- 按帖子查询评论列表
- 按时间排序
- 查询回复列表

**私信查询：**
- 查询用户对话列表
- 查询未读消息
- 按时间排序

**通知查询：**
- 查询用户未读通知
- 按时间排序

---

## 五、性能优化

### 5.1 冗余字段

为了提高查询性能，使用以下冗余字段：

1. **posts表**
   - `like_count` - 点赞数
   - `comment_count` - 评论数
   - `favorite_count` - 收藏数

2. **comments表**
   - `like_count` - 点赞数
   - `reply_count` - 回复数

3. **categories表**
   - `post_count` - 帖子数量

**更新策略：**
- 使用数据库触发器或应用层逻辑更新
- 在点赞/取消点赞时更新计数
- 在评论/删除评论时更新计数

### 5.2 软删除

使用软删除而非物理删除：

- `is_deleted` - 删除标记
- `deleted_at` - 删除时间

**优势：**
- 保留数据用于审计
- 支持恢复功能
- 不影响关联数据

### 5.3 分页优化

- 使用游标分页（cursor-based pagination）
- 使用索引优化排序查询
- 限制每页数量（默认20条）

---

## 六、数据安全

### 6.1 密码安全

- 使用bcrypt加密存储密码
- 密码哈希值存储在`password_hash`字段
- 不在数据库中存储明文密码

### 6.2 敏感信息

- 手机号可选，支持隐私保护
- 邮箱用于登录和通知
- 头像URL支持CDN加速

### 6.3 数据完整性

- 使用外键约束保证数据完整性
- 使用级联删除（CASCADE）处理关联数据
- 使用唯一约束防止重复数据

---

## 七、扩展性设计

### 7.1 预留字段

- 用户表：预留`phone`字段（可选）
- 分类表：预留`icon`、`color`字段
- 通知表：预留`related_id`字段

### 7.2 版本管理

- 所有表包含`created_at`和`updated_at`字段
- 支持软删除的表包含`deleted_at`字段

### 7.3 多态设计

- 点赞表使用`target_type`和`target_id`支持多态
- 通知表使用`type`和`related_id`支持多种通知类型

---

## 八、迁移计划

### 8.1 初始化迁移

```bash
# 生成迁移文件
npx prisma migrate dev --name init

# 应用迁移
npx prisma migrate deploy
```

### 8.2 种子数据

创建初始分类数据：

```sql
INSERT INTO categories (id, name, slug, description, sort_order) VALUES
  (gen_random_uuid(), '学习', 'study', '学习相关话题', 1),
  (gen_random_uuid(), '生活', 'life', '生活相关话题', 2),
  (gen_random_uuid(), '娱乐', 'entertainment', '娱乐相关话题', 3),
  (gen_random_uuid(), '交易', 'trade', '交易信息发布', 4),
  (gen_random_uuid(), '活动', 'activity', '活动组织', 5),
  (gen_random_uuid(), '其他', 'other', '其他话题', 6);
```

---

## 九、最佳实践

### 9.1 命名规范

- 表名：小写，复数形式（users, posts）
- 字段名：小写，下划线分隔（user_id, created_at）
- 索引名：`idx_表名_字段名`

### 9.2 数据类型选择

- UUID：主键和外键
- VARCHAR：短文本（用户名、标题）
- TEXT：长文本（内容、描述）
- INTEGER：整数（计数、排序）
- BOOLEAN：布尔值（标记）
- TIMESTAMP：时间戳

### 9.3 默认值

- 时间字段：`DEFAULT now()`
- 计数字段：`DEFAULT 0`
- 布尔字段：`DEFAULT false`
- 数组字段：`DEFAULT []`

---

## 十、总结

### 10.1 设计特点

✅ **规范化** - 遵循数据库设计规范  
✅ **高性能** - 合理使用索引和冗余字段  
✅ **可扩展** - 预留扩展空间  
✅ **安全性** - 密码加密、数据保护  
✅ **现代化** - 使用Prisma ORM、TypeScript类型

### 10.2 表统计

- **核心表：** 10个
- **关系表：** 3个（likes, favorites, follows）
- **总计：** 10个表

### 10.3 下一步

1. ✅ 数据库设计完成
2. ⏭️ 生成Prisma Client
3. ⏭️ 创建数据库迁移
4. ⏭️ 编写种子数据
5. ⏭️ 测试数据库连接

---

**文档版本：** v1.0  
**创建日期：** 2026-02-06  
**状态：** ✅ 设计完成
