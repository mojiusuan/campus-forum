# 服务器更新部署 - 快速步骤

将本地最新修改（展示页、展示页按钮、情感树洞等）部署到服务器时，按以下顺序执行。

---

## 1. 本地：提交并推送

```bash
cd d:\idea\forum
git add .
git commit -m "展示页、展示页按钮、情感树洞等"
git push origin main
```

（若主分支名为 `master`，将 `main` 改为 `master`。）

---

## 2. 服务器：拉取并部署

**SSH 登录服务器后：**

```bash
cd /var/www/forum
git pull origin main
```

### 2.1 更新后端

```bash
cd /var/www/forum/backend

# 完整安装依赖（构建需要，不要用 --production）
npm install

# 生成 Prisma Client、迁移、种子
npx prisma generate
npx prisma migrate deploy
npx tsx prisma/seed.ts

# 构建并重启
npm run build
pm2 restart forum-api
```

### 2.2 更新前端

```bash
cd /var/www/forum/frontend

npm install
npm run build
```

若使用 Nginx 托管前端，构建产物在 `frontend/dist`，无需额外操作；Nginx 会直接读该目录。

### 2.3 检查

```bash
pm2 status
curl -s http://localhost:3000/api/health
```

浏览器访问你的域名：根路径应为展示页，「展示页」按钮可回到展示页，论坛侧栏有「情感树洞」。

---

## 仅前端有改动时（例如只改了展示页按钮）

若本次只改了前端、没有动后端或数据库，可只做：

```bash
cd /var/www/forum
git pull origin main
cd frontend
npm install
npm run build
```

无需重启后端，也无需再执行迁移或 seed。

---

## 若后端构建报错

参考 `docs/服务器构建问题排查.md`，在 `backend` 目录执行：

```bash
rm -rf node_modules package-lock.json dist
unset NODE_ENV
npm install
npx prisma generate
npm run build
pm2 restart forum-api
```
